{"version":3,"sources":["../../../src/services/scene/SceneService.ts"],"names":["AsyncParallelHook","$window","DOM","elementResizeEvent","unbind","EventEmitter","inject","injectable","TYPES","createRendererContainer","InteractionEvent","Scene","SceneID","IIconService","IFontService","IControlService","IGlobalConfigService","IMapService","ICoordinateSystemService","IRendererService","ILayerService","ICameraService","IInteractionService","IPickingService","IShaderModuleService","IMarkerService","IPopupService","emit","$container","initContainer","triggerResize","coordinateSystemService","needRefresh","render","viewport","cameraService","update","hooks","init","sceneConfig","configService","setSceneConfig","id","shaderModuleService","registerBuiltinModules","iconService","on","fontService","tapPromise","Promise","resolve","map","onCameraChanged","version","initViewPort","handleMapCameraChanged","addMarkerContainer","markerService","addMarkers","addMarkerLayers","popupService","initPopup","interactionService","Drag","addSceneEvent","bind","getSceneConfig","canvas","create","setCanvas","rendererService","handleWindowResized","matchMedia","addListener","console","error","pickingService","initPromise","promise","initMiniMap","layer","layerService","sceneService","add","rendering","destroyed","inited","destroy","loadFont","document","fonts","load","fontFamily","initLayers","controlService","addControls","loaded","updateLayerRenderList","renderLayers","fontPath","style","createElement","type","innerText","getElementsByTagName","appendChild","renderCanvas","layersPng","toDataURL","getPointSizeRange","mapContainer","parentElement","markerContainer","setTimeout","parentNode","removeChild","removeAllListeners","removeListener","pixelRatio","DPR","w","clientWidth","h","clientHeight","width","height","x","y","target"],"mappings":"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","sourcesContent":["// @ts-ignore\nimport { AsyncParallelHook } from '@antv/async-hook';\nimport { $window, DOM } from '@antv/l7-utils';\nimport elementResizeEvent, { unbind } from 'element-resize-event';\nimport { EventEmitter } from 'eventemitter3';\nimport { inject, injectable } from 'inversify';\nimport 'reflect-metadata';\nimport { TYPES } from '../../types';\nimport { createRendererContainer } from '../../utils/dom';\nimport { IFontService } from '../asset/IFontService';\nimport { IIconService } from '../asset/IIconService';\nimport { ICameraService, IViewport } from '../camera/ICameraService';\nimport { IControlService } from '../component/IControlService';\nimport { IMarkerService } from '../component/IMarkerService';\nimport { IPopupService } from '../component/IPopupService';\nimport { IGlobalConfigService, ISceneConfig } from '../config/IConfigService';\nimport { ICoordinateSystemService } from '../coordinate/ICoordinateSystemService';\nimport {\n  IInteractionService,\n  IInteractionTarget,\n  InteractionEvent,\n} from '../interaction/IInteractionService';\nimport { IPickingService } from '../interaction/IPickingService';\nimport { ILayer, ILayerService } from '../layer/ILayerService';\nimport { IMapCamera, IMapConfig, IMapService } from '../map/IMapService';\nimport { IRenderConfig, IRendererService } from '../renderer/IRendererService';\nimport { IShaderModuleService } from '../shader/IShaderModuleService';\nimport { ISceneService } from './ISceneService';\n\n/**\n * will emit `loaded` `resize` `destroy` event panstart panmove panend\n */\n@injectable()\nexport default class Scene extends EventEmitter implements ISceneService {\n  public destroyed: boolean = false;\n\n  public loaded: boolean = false;\n  // loadFont 判断用户当前是否添加自定义字体\n  public loadFont: boolean = false;\n  // fontFamily 用户当前自己添加的字体的名称\n  public fontFamily: string = '';\n\n  @inject(TYPES.SceneID)\n  private readonly id: string;\n  /**\n   * 使用各种 Service\n   */\n  @inject(TYPES.IIconService)\n  private readonly iconService: IIconService;\n\n  @inject(TYPES.IFontService)\n  private readonly fontService: IFontService;\n\n  @inject(TYPES.IControlService)\n  private readonly controlService: IControlService;\n\n  @inject(TYPES.IGlobalConfigService)\n  private readonly configService: IGlobalConfigService;\n\n  @inject(TYPES.IMapService)\n  private readonly map: IMapService;\n\n  @inject(TYPES.ICoordinateSystemService)\n  private readonly coordinateSystemService: ICoordinateSystemService;\n\n  @inject(TYPES.IRendererService)\n  private readonly rendererService: IRendererService;\n\n  @inject(TYPES.ILayerService)\n  private readonly layerService: ILayerService;\n\n  @inject(TYPES.ICameraService)\n  private readonly cameraService: ICameraService;\n\n  @inject(TYPES.IInteractionService)\n  private readonly interactionService: IInteractionService;\n\n  @inject(TYPES.IPickingService)\n  private readonly pickingService: IPickingService;\n\n  @inject(TYPES.IShaderModuleService)\n  private readonly shaderModuleService: IShaderModuleService;\n\n  @inject(TYPES.IMarkerService)\n  private readonly markerService: IMarkerService;\n\n  @inject(TYPES.IPopupService)\n  private readonly popupService: IPopupService;\n\n  /**\n   * 是否首次渲染\n   */\n  private inited: boolean = false;\n  private initPromise: Promise<void>;\n\n  // TODO: 改成状态机\n  private rendering: boolean = false;\n\n  /**\n   * canvas 容器\n   */\n  private $container: HTMLDivElement | null | HTMLCanvasElement;\n\n  private canvas: HTMLCanvasElement;\n\n  private markerContainer: HTMLElement;\n\n  private hooks: {\n    init: AsyncParallelHook;\n  };\n\n  public constructor() {\n    super();\n    // @see https://github.com/webpack/tapable#usage\n    this.hooks = {\n      /**\n       * 初始化异步任务，可并行：\n       * 1. initMap：初始化地图底图、相机\n       * 2. initRenderer：初始化渲染引擎\n       * 3. initWorker：初始化 Worker\n       */\n      init: new AsyncParallelHook(),\n    };\n  }\n\n  public init(sceneConfig: ISceneConfig) {\n    // 设置场景配置项\n    this.configService.setSceneConfig(this.id, sceneConfig);\n    // 初始化 ShaderModule\n    this.shaderModuleService.registerBuiltinModules();\n\n    // 初始化资源管理 图片\n    this.iconService.init();\n    this.iconService.on('imageUpdate', () => this.render());\n    // 字体资源\n    this.fontService.init();\n\n    /**\n     * 初始化底图\n     */\n    this.hooks.init.tapPromise('initMap', async () => {\n      // 等待首次相机同步\n      await new Promise<void>((resolve) => {\n        this.map.onCameraChanged((viewport: IViewport) => {\n          this.cameraService.init();\n          this.cameraService.update(viewport);\n          if (this.map.version !== 'GAODE2.x') {\n            // not amap2\n            resolve();\n          }\n        });\n\n        if (this.map.version !== 'GAODE2.x') {\n          // not amap2\n          this.map.init();\n        } else {\n          // amap2\n          resolve();\n        }\n      });\n\n      if (this.map.version === 'GAODE2.x' && this.map.initViewPort) {\n        // amap2\n        await this.map.init();\n        this.map.initViewPort();\n      }\n\n      // 重新绑定非首次相机更新事件\n      this.map.onCameraChanged(this.handleMapCameraChanged);\n      this.map.addMarkerContainer();\n\n      // 初始化未加载的marker;\n      this.markerService.addMarkers();\n      this.markerService.addMarkerLayers();\n      this.popupService.initPopup();\n      // 地图初始化之后 才能初始化 container 上的交互\n      this.interactionService.init();\n      this.interactionService.on(\n        InteractionEvent.Drag,\n        this.addSceneEvent.bind(this),\n      );\n    });\n\n    /**\n     * 初始化渲染引擎\n     */\n    this.hooks.init.tapPromise('initRenderer', async () => {\n      // 创建底图之上的 container\n      const $container = createRendererContainer(\n        this.configService.getSceneConfig(this.id).id || '',\n      );\n\n      // 添加marker container;\n      this.$container = $container;\n\n      if ($container) {\n        this.canvas = DOM.create('canvas', '', $container) as HTMLCanvasElement;\n        this.setCanvas();\n        await this.rendererService.init(\n          // @ts-ignore\n          this.canvas,\n          this.configService.getSceneConfig(this.id) as IRenderConfig,\n        );\n\n        elementResizeEvent(\n          this.$container as HTMLDivElement,\n          this.handleWindowResized,\n        );\n        if ($window.matchMedia) {\n          $window\n            .matchMedia('screen and (-webkit-min-device-pixel-ratio: 1.5)')\n            ?.addListener(this.handleWindowResized);\n        }\n      } else {\n        console.error('容器 id 不存在');\n      }\n      this.pickingService.init(this.id);\n    });\n    // TODO：init worker, fontAtlas...\n\n    // 执行异步并行初始化任务\n    // @ts-ignore\n    this.initPromise = this.hooks.init.promise();\n    this.render();\n  }\n\n  /**\n   * 小程序环境下初始化 Scene\n   * @param sceneConfig\n   */\n  public initMiniScene(sceneConfig: ISceneConfig) {\n    // 设置场景配置项\n    this.configService.setSceneConfig(this.id, sceneConfig);\n\n    // 初始化 ShaderModule\n    this.shaderModuleService.registerBuiltinModules();\n\n    // 初始化资源管理 图片\n    this.iconService.init();\n    this.iconService.on('imageUpdate', () => this.render());\n    // 字体资源\n    this.fontService.init();\n\n    /**\n     * 初始化底图\n     */\n    this.hooks.init.tapPromise('initMap', async () => {\n      // 等待首次相机同步\n      await new Promise<void>((resolve) => {\n        this.map.onCameraChanged((viewport: IViewport) => {\n          this.cameraService.init();\n          this.cameraService.update(viewport);\n          if (this.map.version !== 'GAODE2.x') {\n            // not amap2\n            resolve();\n          }\n        });\n        // @ts-ignore\n        this.map.initMiniMap();\n      });\n\n      // 重新绑定非首次相机更新事件\n      this.map.onCameraChanged(this.handleMapCameraChanged);\n\n      // 地图初始化之后 才能初始化 container 上的交互\n      this.interactionService.init();\n      this.interactionService.on(\n        InteractionEvent.Drag,\n        this.addSceneEvent.bind(this),\n      );\n    });\n\n    /**\n     * 初始化渲染引擎\n     */\n    this.hooks.init.tapPromise('initRenderer', async () => {\n      // 创建底图之上的 container\n      const $container = sceneConfig.canvas;\n\n      // 添加marker container;\n      this.$container = $container ? $container : null;\n      if (this.$container) {\n        await this.rendererService.init(\n          // @ts-ignore\n          sceneConfig.canvas,\n          this.configService.getSceneConfig(this.id) as IRenderConfig,\n        );\n      } else {\n        console.error('容器 id 不存在');\n      }\n\n      this.pickingService.init(this.id);\n    });\n    // TODO：init worker, fontAtlas...\n\n    // 执行异步并行初始化任务\n    // @ts-ignore\n    this.initPromise = this.hooks.init.promise();\n    this.render();\n  }\n\n  public addLayer(layer: ILayer) {\n    this.layerService.sceneService = this;\n    this.layerService.add(layer);\n    this.render();\n  }\n\n  public async render() {\n    if (this.rendering || this.destroyed) {\n      return;\n    }\n    this.rendering = true;\n    // 首次初始化，或者地图的容器被强制销毁的需要重新初始化\n    if (!this.inited) {\n      // 还未初始化完成需要等待\n\n      await this.initPromise;\n      if (this.destroyed) {\n        this.destroy();\n      }\n      // @ts-ignore\n      if (this.loadFont && document.fonts) {\n        // @ts-ignore\n        await document.fonts.load(`24px ${this.fontFamily}`, 'L7text');\n      }\n      // FIXME: 初始化 marker 容器，可以放到 map 初始化方法中？\n      this.layerService.initLayers();\n      this.controlService.addControls();\n      this.loaded = true;\n      this.emit('loaded');\n      this.inited = true;\n    }\n\n    // 尝试初始化未初始化的图层\n    this.layerService.updateLayerRenderList();\n    this.layerService.renderLayers();\n\n    // 组件需要等待layer 初始化完成之后添加\n    this.rendering = false;\n  }\n\n  /**\n   * 用户自定义添加第三方字体 （用户使用 layer/point/text/iconfont 的前提需要加载第三方字体文件）\n   * @param fontFamily\n   * @param fontPath\n   */\n  public addFontFace(fontFamily: string, fontPath: string): void {\n    this.fontFamily = fontFamily;\n    const style = document.createElement('style');\n    style.type = 'text/css';\n    style.innerText = `\n        @font-face{\n            font-family: '${fontFamily}';\n            src: url('${fontPath}') format('woff2'),\n            url('${fontPath}') format('woff'),\n            url('${fontPath}') format('truetype');\n        }`;\n    document.getElementsByTagName('head')[0].appendChild(style);\n    this.loadFont = true;\n  }\n\n  public getSceneContainer(): HTMLDivElement {\n    return this.$container as HTMLDivElement;\n  }\n\n  public exportPng(type?: 'png' | 'jpg'): string {\n    const renderCanvas = this.$container?.getElementsByTagName('canvas')[0];\n    this.render();\n    const layersPng =\n      type === 'jpg'\n        ? (renderCanvas?.toDataURL('image/jpeg') as string)\n        : (renderCanvas?.toDataURL('image/png') as string);\n    return layersPng;\n  }\n\n  public getSceneConfig(): Partial<ISceneConfig> {\n    return this.configService.getSceneConfig(this.id as string);\n  }\n\n  // get point size info\n  public getPointSizeRange() {\n    return this.rendererService.getPointSizeRange();\n  }\n\n  public addMarkerContainer(): void {\n    // @ts-ignore\n    const mapContainer = this.$container.parentElement as HTMLElement;\n    if (mapContainer !== null) {\n      this.markerContainer = DOM.create(\n        'div',\n        'l7-marker-container',\n        mapContainer,\n      );\n    }\n  }\n\n  public getMarkerContainer() {\n    return this.markerContainer;\n  }\n\n  public destroy() {\n    if (!this.inited) {\n      this.destroyed = true;\n      return;\n    }\n    this.emit('destroy');\n\n    this.layerService.destroy();\n    // this.rendererService.destroy();\n    setTimeout(() => {\n      // Tip: 把这一部分销毁放到写下一个事件循环中执行，兼容 L7React 中 scene 和 layer 同时销毁的情况\n      this.rendererService.destroy();\n    });\n\n    this.map.destroy();\n\n    this.interactionService.destroy();\n    this.controlService.destroy();\n    this.markerService.destroy();\n    this.fontService.destroy();\n    this.iconService.destroy();\n\n    // TODO: 销毁 container 容器\n    this.$container?.parentNode?.removeChild(this.$container);\n\n    this.removeAllListeners();\n    this.inited = false;\n    unbind(this.$container as HTMLDivElement, this.handleWindowResized);\n    if ($window.matchMedia) {\n      $window\n        .matchMedia('screen and (min-resolution: 2dppx)')\n        ?.removeListener(this.handleWindowResized);\n    }\n  }\n\n  private handleWindowResized = () => {\n    this.emit('resize');\n    // @ts-check\n    if (this.$container) {\n      this.initContainer();\n      DOM.triggerResize();\n      this.coordinateSystemService.needRefresh = true;\n\n      //  repaint layers\n      this.render();\n    }\n  };\n  private initContainer() {\n    const pixelRatio = DOM.DPR;\n    const w = this.$container?.clientWidth || 400;\n    const h = this.$container?.clientHeight || 300;\n    const canvas = this.canvas;\n    if (canvas) {\n      canvas.width = w * pixelRatio;\n      canvas.height = h * pixelRatio;\n      // canvas.style.width = `${w}px`;\n      // canvas.style.height = `${h}px`;\n    }\n    this.rendererService.viewport({\n      x: 0,\n      y: 0,\n      width: pixelRatio * w,\n      height: pixelRatio * h,\n    });\n  }\n\n  private setCanvas() {\n    const pixelRatio = DOM.DPR;\n    const w = this.$container?.clientWidth || 400;\n    const h = this.$container?.clientHeight || 300;\n    const canvas = this.canvas;\n    canvas.width = w * pixelRatio;\n    canvas.height = h * pixelRatio;\n    // canvas.style.width = `${w}px`;\n    // canvas.style.height = `${h}px`;\n    canvas.style.width = '100%';\n    canvas.style.height = '100%';\n  }\n\n  private handleMapCameraChanged = (viewport: IViewport) => {\n    this.cameraService.update(viewport);\n    this.render();\n  };\n\n  private addSceneEvent(target: IInteractionTarget) {\n    this.emit(target.type, target);\n  }\n}\n"],"file":"SceneService.js"}