{"version":3,"sources":["../../../src/services/layer/LayerService.ts"],"names":["LayerService","TYPES","IRendererService","IMapService","IGlobalConfigService","Clock","layer","sceneInited","init","layers","push","updateLayerRenderList","forEach","inited","layerList","id","find","name","parentLayer","layerIndex","layerChildren","indexOf","splice","renderLayers","destroy","flag","enableRender","alreadyInRendering","clear","hooks","beforeRenderData","call","beforeRender","getLayerConfig","enableMultiPassRenderer","renderMultiPass","render","afterRender","filter","isVisible","childlayer","sort","pre","next","zIndex","child","animateInstanceCount","clock","start","runRender","stopRender","stop","renderService","extensionObject","OES_texture_float","mapService","dragging","shaderPicking","layerRenderID","$window","requestAnimationFrame","bind","color","bgColor","depth","stencil","framebuffer","cancelAnimationFrame"],"mappings":"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","sourcesContent":["import { $window, rgb2arr } from '@antv/l7-utils';\nimport { inject, injectable } from 'inversify';\nimport 'reflect-metadata';\nimport { ILayer } from '../..';\nimport { TYPES } from '../../types';\nimport Clock from '../../utils/clock';\nimport { IGlobalConfigService } from '../config/IConfigService';\nimport { IMapService } from '../map/IMapService';\nimport { IRendererService } from '../renderer/IRendererService';\nimport { ILayerModel, ILayerService } from './ILayerService';\n\n@injectable()\nexport default class LayerService implements ILayerService {\n  public clock = new Clock();\n\n  public alreadyInRendering: boolean = false;\n\n  private layers: ILayer[] = [];\n\n  private layerList: ILayer[] = [];\n\n  private layerRenderID: number;\n\n  private sceneInited: boolean = false;\n\n  private animateInstanceCount: number = 0;\n\n  // TODO: 是否开启 shader 中的颜色拾取计算\n  private shaderPicking: boolean = true;\n\n  private enableRender: boolean = true;\n\n  @inject(TYPES.IRendererService)\n  private readonly renderService: IRendererService;\n\n  @inject(TYPES.IMapService)\n  private readonly mapService: IMapService;\n\n  @inject(TYPES.IGlobalConfigService)\n  private readonly configService: IGlobalConfigService;\n\n  public add(layer: ILayer) {\n    if (this.sceneInited) {\n      layer.init();\n    }\n    this.layers.push(layer);\n    this.updateLayerRenderList();\n  }\n\n  public initLayers() {\n    this.sceneInited = true;\n    this.layers.forEach((layer) => {\n      if (!layer.inited) {\n        layer.init();\n      }\n    });\n    this.updateLayerRenderList();\n  }\n\n  public getRenderList(): ILayer[] {\n    return this.layerList;\n  }\n\n  public getLayers(): ILayer[] {\n    return this.layers;\n  }\n\n  public getLayer(id: string): ILayer | undefined {\n    return this.layers.find((layer) => layer.id === id);\n  }\n\n  public getLayerByName(name: string): ILayer | undefined {\n    return this.layers.find((layer) => layer.name === name);\n  }\n\n  public cleanRemove(layer: ILayer, parentLayer?: ILayer) {\n    // Tip: layer.layerChildren 当 layer 存在子图层的情况\n    if (parentLayer) {\n      const layerIndex = parentLayer.layerChildren.indexOf(layer);\n      if (layerIndex > -1) {\n        parentLayer.layerChildren.splice(layerIndex, 1);\n      }\n    } else {\n      const layerIndex = this.layers.indexOf(layer);\n      if (layerIndex > -1) {\n        this.layers.splice(layerIndex, 1);\n      }\n    }\n    this.updateLayerRenderList();\n    this.renderLayers();\n  }\n\n  public remove(layer: ILayer, parentLayer?: ILayer): void {\n    // Tip: layer.layerChildren 当 layer 存在子图层的情况\n    if (parentLayer) {\n      const layerIndex = parentLayer.layerChildren.indexOf(layer);\n      if (layerIndex > -1) {\n        parentLayer.layerChildren.splice(layerIndex, 1);\n      }\n    } else {\n      const layerIndex = this.layers.indexOf(layer);\n      if (layerIndex > -1) {\n        this.layers.splice(layerIndex, 1);\n      }\n    }\n    this.updateLayerRenderList();\n    layer.destroy();\n    this.renderLayers();\n  }\n\n  public removeAllLayers() {\n    this.destroy();\n  }\n\n  public setEnableRender(flag: boolean) {\n    this.enableRender = flag;\n  }\n\n  public async renderLayers() {\n    if (this.alreadyInRendering || !this.enableRender) {\n      return;\n    }\n    this.alreadyInRendering = true;\n    this.clear();\n\n    for (const layer of this.layerList) {\n      layer.hooks.beforeRenderData.call();\n      layer.hooks.beforeRender.call();\n      if (layer.getLayerConfig().enableMultiPassRenderer) {\n        // multiPassRender 不是同步渲染完成的\n        await layer.renderMultiPass();\n      } else {\n        layer.render();\n      }\n      layer.hooks.afterRender.call();\n    }\n\n    // this.layerList.forEach((layer) => {\n    //   layer.hooks.beforeRenderData.call();\n    //   layer.hooks.beforeRender.call();\n    //   layer.render();\n    //   layer.hooks.afterRender.call();\n    // });\n    this.alreadyInRendering = false;\n  }\n\n  public updateLayerRenderList() {\n    // TODO: 每次更新都是从 layers 重新构建\n    this.layerList = [];\n    this.layers\n      .filter((layer) => layer.inited)\n      .filter((layer) => layer.isVisible())\n      .forEach((layer) => {\n        this.layerList.push(layer);\n\n        // Tip: 渲染 layer 的子图层 默认 layerChildren 为空数组 表示没有子图层 目前只有 ImageTileLayer 有子图层\n        layer.layerChildren\n          .filter((childlayer) => childlayer.inited)\n          .filter((childlayer) => childlayer.isVisible())\n          .forEach((childlayer) => {\n            this.layerList.push(childlayer);\n          });\n      });\n\n    // 根据 zIndex 对渲染顺序进行排序\n    this.layerList.sort((pre: ILayer, next: ILayer) => {\n      return pre.zIndex - next.zIndex;\n    });\n  }\n\n  public destroy() {\n    this.layers.forEach((layer) => {\n      // Tip: layer.layerChildren 当 layer 存在子图层的情况\n      if (layer.layerChildren) {\n        layer.layerChildren.forEach((child) => child.destroy());\n        layer.layerChildren = [];\n      }\n      layer.destroy();\n    });\n    this.layers = [];\n    this.layerList = [];\n    this.renderLayers();\n  }\n\n  public startAnimate() {\n    if (this.animateInstanceCount++ === 0) {\n      this.clock.start();\n      this.runRender();\n    }\n  }\n\n  public stopAnimate() {\n    if (--this.animateInstanceCount === 0) {\n      this.stopRender();\n      this.clock.stop();\n    }\n  }\n\n  public getOESTextureFloat() {\n    return this.renderService.extensionObject.OES_texture_float;\n  }\n\n  // TODO: 判断地图是否正在被拖动\n  public isMapDragging() {\n    return this.mapService.dragging;\n  }\n\n  // 控制着色器颜色拾取计算\n  public enableShaderPick() {\n    this.shaderPicking = true;\n  }\n\n  public disableShaderPick() {\n    this.shaderPicking = false;\n  }\n\n  public getShaderPickStat() {\n    return this.shaderPicking;\n  }\n\n  private runRender() {\n    this.renderLayers();\n    this.layerRenderID = $window.requestAnimationFrame(\n      this.runRender.bind(this),\n    );\n  }\n\n  private clear() {\n    const color = rgb2arr(this.mapService.bgColor) as [\n      number,\n      number,\n      number,\n      number,\n    ];\n    this.renderService.clear({\n      color,\n      depth: 1,\n      stencil: 0,\n      framebuffer: null,\n    });\n  }\n\n  private stopRender() {\n    $window.cancelAnimationFrame(this.layerRenderID);\n  }\n}\n"],"file":"LayerService.js"}