{"version":3,"sources":["../../src/mapbox/map.ts"],"names":["CoordinateSystem","MapServiceEvent","TYPES","DOM","mat4","vec3","inject","injectable","mapboxgl","Version","Viewport","window","EventMap","mapmove","camerachange","zoomchange","dragging","MapTheme","mapdivCount","LNGLAT_OFFSET_ZOOM_THRESHOLD","MAPBOX_API_KEY","MapboxService","MapConfig","IGlobalConfigService","ICoordinateSystemService","IEventEmitter","MAPBOX","map","getCenter","wrap","lat","lng","emit","viewport","syncWithMapCamera","bearing","getBearing","center","viewportHeight","transform","height","pitch","getPitch","viewportWidth","width","zoom","getZoom","cameraHeight","config","offsetZoom","coordinateSystemService","setCoordinateSystem","LNGLAT_OFFSET","LNGLAT","cameraChangedCallback","color","bgColor","container","getCanvasContainer","markerContainer","create","setAttribute","type","handle","indexOf","eventEmitter","on","off","getContainer","size","setZoom","lnglat","setCenter","getBounds","toArray","getMinZoom","getMaxZoom","rotation","setBearing","option","eventData","zoomIn","zoomOut","setPitch","p","panTo","x","y","bound","fitBoundsOptions","fitBounds","max","setMaxZoom","min","setMinZoom","doubleClickZoom","enable","disable","dragEnable","dragPan","rotateEnable","dragRotate","keyboardEnable","keyboard","zoomEnable","scrollZoom","flyTo","style","setStyle","getMapStyle","pixel","unproject","project","origin","z","lngLatToMercator","altitude","MercatorCoordinate","fromLngLat","rotate","scale","modelAsMercatorCoordinate","meters","meterInMercatorCoordinateUnits","modelMatrix","translate","fromValues","rotateX","rotateY","rotateZ","id","attributionControl","token","mapInstance","rest","console","error","configService","getSceneWarninfo","accessToken","warn","$mapContainer","creatAmapContainer","Map","handleCameraChanged","parentNode","removeChild","removeAllListeners","remove","name","args","once","outer","centerLnglat","LngLat","outerLnglat","meterDis","distanceTo","centerMercator","outerMercator","x1","y1","x2","y2","coordDis","Math","sqrt","pow","renderCanvas","getCanvas","layersPng","toDataURL","callback","$wrapper","document","getElementById","$amapdiv","createElement","cssText","appendChild"],"mappings":"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","sourcesContent":["/**\n * MapboxService\n */\nimport {\n  Bounds,\n  CoordinateSystem,\n  ICoordinateSystemService,\n  IGlobalConfigService,\n  ILngLat,\n  IMapConfig,\n  IMapService,\n  IMercator,\n  IPoint,\n  IStatusOptions,\n  IViewport,\n  MapServiceEvent,\n  MapStyle,\n  TYPES,\n} from '@antv/l7-core';\nimport { DOM } from '@antv/l7-utils';\nimport { mat4, vec2, vec3 } from 'gl-matrix';\nimport { inject, injectable } from 'inversify';\nimport mapboxgl, { IControl, Map } from 'mapbox-gl';\n// tslint:disable-next-line:no-submodule-imports\nimport 'mapbox-gl/dist/mapbox-gl.css';\nimport 'reflect-metadata';\nimport { IMapboxInstance } from '../../typings/index';\nimport { Version } from '../version';\nimport Viewport from './Viewport';\nwindow.mapboxgl = mapboxgl;\nconst EventMap: {\n  [key: string]: any;\n} = {\n  mapmove: 'move',\n  camerachange: 'move',\n  zoomchange: 'zoom',\n  dragging: 'drag',\n};\nimport { MapTheme } from './theme';\nlet mapdivCount = 0;\nconst LNGLAT_OFFSET_ZOOM_THRESHOLD = 12;\nconst MAPBOX_API_KEY =\n  'pk.eyJ1IjoibHp4dWUiLCJhIjoiY2tvaWZuM2s4MWZuYjJ1dHI5ZGduYTlrdiJ9.DQCfMRbZzx0VSwecQ69McA';\n/**\n * AMapService\n */\n@injectable()\nexport default class MapboxService\n  implements IMapService<Map & IMapboxInstance> {\n  public version: string = Version.MAPBOX;\n  public map: Map & IMapboxInstance;\n\n  // TODO: 判断地图是否正在拖拽\n  public dragging: boolean = false;\n\n  // 背景色\n  public bgColor: string = 'rgba(0.0, 0.0, 0.0, 0.0)';\n\n  @inject(TYPES.MapConfig)\n  private readonly config: Partial<IMapConfig>;\n\n  @inject(TYPES.IGlobalConfigService)\n  private readonly configService: IGlobalConfigService;\n\n  @inject(TYPES.ICoordinateSystemService)\n  private readonly coordinateSystemService: ICoordinateSystemService;\n\n  @inject(TYPES.IEventEmitter)\n  private eventEmitter: any;\n  private viewport: Viewport;\n  private markerContainer: HTMLElement;\n  private cameraChangedCallback: (viewport: IViewport) => void;\n  private $mapContainer: HTMLElement | null;\n  public setBgColor(color: string) {\n    this.bgColor = color;\n  }\n\n  // init\n  public addMarkerContainer(): void {\n    const container = this.map.getCanvasContainer();\n    this.markerContainer = DOM.create('div', 'l7-marker-container', container);\n    this.markerContainer.setAttribute('tabindex', '-1');\n  }\n\n  public getMarkerContainer(): HTMLElement {\n    return this.markerContainer;\n  }\n\n  //  map event\n  public on(type: string, handle: (...args: any[]) => void): void {\n    if (MapServiceEvent.indexOf(type) !== -1) {\n      this.eventEmitter.on(type, handle);\n    } else {\n      // 统一事件名称\n      this.map.on(EventMap[type] || type, handle);\n    }\n  }\n  public off(type: string, handle: (...args: any[]) => void): void {\n    this.map.off(EventMap[type] || type, handle);\n  }\n\n  public getContainer(): HTMLElement | null {\n    return this.map.getContainer();\n  }\n\n  public getMapCanvasContainer(): HTMLElement {\n    return this.map.getCanvasContainer() as HTMLElement;\n  }\n\n  public getSize(): [number, number] {\n    const size = this.map.transform;\n    return [size.width, size.height];\n  }\n  // get mapStatus method\n\n  public getType() {\n    return 'mapbox';\n  }\n\n  public getZoom(): number {\n    return this.map.getZoom();\n  }\n\n  public setZoom(zoom: number) {\n    return this.map.setZoom(zoom);\n  }\n\n  public getCenter(): ILngLat {\n    return this.map.getCenter();\n  }\n\n  public setCenter(lnglat: [number, number]): void {\n    this.map.setCenter(lnglat);\n  }\n\n  public getPitch(): number {\n    return this.map.getPitch();\n  }\n\n  public getRotation(): number {\n    return this.map.getBearing();\n  }\n\n  public getBounds(): Bounds {\n    return this.map.getBounds().toArray() as Bounds;\n  }\n\n  public getMinZoom(): number {\n    return this.map.getMinZoom();\n  }\n\n  public getMaxZoom(): number {\n    return this.map.getMaxZoom();\n  }\n\n  public setRotation(rotation: number): void {\n    this.map.setBearing(rotation);\n  }\n\n  public zoomIn(option?: any, eventData?: any): void {\n    this.map.zoomIn(option, eventData);\n  }\n  public zoomOut(option?: any, eventData?: any): void {\n    this.map.zoomOut(option, eventData);\n  }\n  public setPitch(pitch: number) {\n    return this.map.setPitch(pitch);\n  }\n\n  public panTo(p: [number, number]): void {\n    this.map.panTo(p);\n  }\n\n  public panBy(x: number, y: number): void {\n    this.panTo([x, y]);\n  }\n\n  public fitBounds(bound: Bounds, fitBoundsOptions?: unknown): void {\n    this.map.fitBounds(bound, fitBoundsOptions as mapboxgl.FitBoundsOptions);\n  }\n\n  public setMaxZoom(max: number): void {\n    this.map.setMaxZoom(max);\n  }\n\n  public setMinZoom(min: number): void {\n    this.map.setMinZoom(min);\n  }\n  public setMapStatus(option: Partial<IStatusOptions>): void {\n    if (option.doubleClickZoom === true) {\n      this.map.doubleClickZoom.enable();\n    }\n    if (option.doubleClickZoom === false) {\n      this.map.doubleClickZoom.disable();\n    }\n    if (option.dragEnable === false) {\n      this.map.dragPan.disable();\n    }\n    if (option.dragEnable === true) {\n      this.map.dragPan.enable();\n    }\n    if (option.rotateEnable === false) {\n      this.map.dragRotate.disable();\n    }\n    if (option.rotateEnable === true) {\n      this.map.dragRotate.enable();\n    }\n    if (option.keyboardEnable === false) {\n      this.map.keyboard.disable();\n    }\n    if (option.keyboardEnable === true) {\n      this.map.keyboard.enable();\n    }\n    if (option.zoomEnable === false) {\n      this.map.scrollZoom.disable();\n    }\n    if (option.zoomEnable === true) {\n      this.map.scrollZoom.enable();\n    }\n  }\n\n  public setZoomAndCenter(zoom: number, center: [number, number]): void {\n    this.map.flyTo({\n      zoom,\n      center,\n    });\n  }\n\n  public setMapStyle(style: any): void {\n    this.map.setStyle(this.getMapStyle(style));\n  }\n  // TODO: 计算像素坐标\n  public pixelToLngLat(pixel: [number, number]): ILngLat {\n    return this.map.unproject(pixel);\n  }\n\n  public lngLatToPixel(lnglat: [number, number]): IPoint {\n    return this.map.project(lnglat);\n  }\n\n  public containerToLngLat(pixel: [number, number]): ILngLat {\n    return this.map.unproject(pixel);\n  }\n\n  public lngLatToContainer(lnglat: [number, number]): IPoint {\n    return this.map.project(lnglat);\n  }\n\n  /**\n   * 将经纬度转成墨卡托坐标\n   * @param lnglat\n   * @returns\n   */\n  public lngLatToCoord(\n    lnglat: [number, number],\n    origin: IMercator = { x: 0, y: 0, z: 0 },\n  ) {\n    // @ts-ignore\n    const { x, y } = this.lngLatToMercator(lnglat, 0);\n    return [x - origin.x, y - origin.y] as [number, number];\n  }\n\n  public lngLatToMercator(\n    lnglat: [number, number],\n    altitude: number,\n  ): IMercator {\n    const {\n      x = 0,\n      y = 0,\n      z = 0,\n    } = window.mapboxgl.MercatorCoordinate.fromLngLat(lnglat, altitude);\n    return { x, y, z };\n  }\n  public getModelMatrix(\n    lnglat: [number, number],\n    altitude: number,\n    rotate: [number, number, number],\n    scale: [number, number, number] = [1, 1, 1],\n    origin: IMercator = { x: 0, y: 0, z: 0 },\n  ): number[] {\n    const modelAsMercatorCoordinate = window.mapboxgl.MercatorCoordinate.fromLngLat(\n      lnglat,\n      altitude,\n    );\n    // @ts-ignore\n    const meters = modelAsMercatorCoordinate.meterInMercatorCoordinateUnits();\n    const modelMatrix = mat4.create();\n\n    mat4.translate(\n      modelMatrix,\n      modelMatrix,\n      vec3.fromValues(\n        modelAsMercatorCoordinate.x - origin.x,\n        modelAsMercatorCoordinate.y - origin.y,\n        modelAsMercatorCoordinate.z || 0 - origin.z,\n      ),\n    );\n\n    mat4.scale(\n      modelMatrix,\n      modelMatrix,\n      vec3.fromValues(meters * scale[0], -meters * scale[1], meters * scale[2]),\n    );\n\n    mat4.rotateX(modelMatrix, modelMatrix, rotate[0]);\n    mat4.rotateY(modelMatrix, modelMatrix, rotate[1]);\n    mat4.rotateZ(modelMatrix, modelMatrix, rotate[2]);\n\n    return (modelMatrix as unknown) as number[];\n  }\n\n  public async init(): Promise<void> {\n    const {\n      id = 'map',\n      attributionControl = false,\n      style = 'light',\n      token = MAPBOX_API_KEY,\n      rotation = 0,\n      mapInstance,\n      ...rest\n    } = this.config;\n\n    this.viewport = new Viewport();\n\n    /**\n     * TODO: 使用 mapbox v0.53.x 版本 custom layer，需要共享 gl context\n     * @see https://github.com/mapbox/mapbox-gl-js/blob/master/debug/threejs.html#L61-L64\n     */\n\n    // 判断全局 mapboxgl 对象的加载\n    if (!mapInstance && !window.mapboxgl) {\n      // 用户有时传递进来的实例是继承于 mapbox 实例化的，不一定是 mapboxgl 对象。\n      console.error(this.configService.getSceneWarninfo('SDK'));\n    }\n\n    if (\n      token === MAPBOX_API_KEY &&\n      style !== 'blank' &&\n      !window.mapboxgl.accessToken &&\n      !mapInstance // 如果用户传递了 mapInstance，应该不去干预实例的 accessToken。\n    ) {\n      console.warn(this.configService.getSceneWarninfo('MapToken'));\n    }\n\n    // 判断是否设置了 accessToken\n    if (!mapInstance && !window.mapboxgl.accessToken) {\n      // 用户有时传递进来的实例是继承于 mapbox 实例化的，不一定是 mapboxgl 对象。\n      window.mapboxgl.accessToken = token;\n    }\n\n    if (mapInstance) {\n      // @ts-ignore\n      this.map = mapInstance;\n      this.$mapContainer = this.map.getContainer();\n    } else {\n      this.$mapContainer = this.creatAmapContainer(id);\n      // @ts-ignore\n      this.map = new window.mapboxgl.Map({\n        container: this.$mapContainer,\n        style: this.getMapStyle(style),\n        attributionControl,\n        bearing: rotation,\n        ...rest,\n      });\n    }\n    this.map.on('load', this.handleCameraChanged);\n    this.map.on('move', this.handleCameraChanged);\n\n    // TODO: 判断地图是否正在被拖拽\n    this.map.on('dragstart', () => {\n      this.dragging = true;\n      return '';\n    });\n    this.map.on('dragend', () => {\n      this.dragging = false;\n      return '';\n    });\n\n    // 不同于高德地图，需要手动触发首次渲染\n    this.handleCameraChanged();\n  }\n\n  public destroy() {\n    // TODO: 销毁地图可视化层的容器\n    this.$mapContainer?.parentNode?.removeChild(this.$mapContainer);\n\n    this.eventEmitter.removeAllListeners();\n    if (this.map) {\n      this.map.remove();\n      this.$mapContainer = null;\n    }\n  }\n  public emit(name: string, ...args: any[]) {\n    this.eventEmitter.emit(name, ...args);\n  }\n  public once(name: string, ...args: any[]) {\n    this.eventEmitter.once(name, ...args);\n  }\n\n  public getMapContainer() {\n    return this.$mapContainer;\n  }\n\n  public meterToCoord(center: [number, number], outer: [number, number]) {\n    // 统一根据经纬度来转化\n    // Tip: 实际米距离 unit meter\n    const centerLnglat = new mapboxgl.LngLat(center[0], center[1]);\n\n    const outerLnglat = new mapboxgl.LngLat(outer[0], outer[1]);\n    const meterDis = centerLnglat.distanceTo(outerLnglat);\n\n    // Tip: 三维世界坐标距离\n\n    const centerMercator = mapboxgl.MercatorCoordinate.fromLngLat({\n      lng: center[0],\n      lat: center[1],\n    });\n    const outerMercator = mapboxgl.MercatorCoordinate.fromLngLat({\n      lng: outer[0],\n      lat: outer[1],\n    });\n    const { x: x1, y: y1 } = centerMercator;\n    const { x: x2, y: y2 } = outerMercator;\n    // Math.pow(2, 22) 4194304\n    const coordDis =\n      Math.sqrt(Math.pow(x1 - x2, 2) + Math.pow(y1 - y2, 2)) * 4194304 * 2;\n\n    return coordDis / meterDis;\n  }\n\n  public exportMap(type: 'jpg' | 'png'): string {\n    const renderCanvas = this.map.getCanvas();\n    const layersPng =\n      type === 'jpg'\n        ? (renderCanvas?.toDataURL('image/jpeg') as string)\n        : (renderCanvas?.toDataURL('image/png') as string);\n    return layersPng;\n  }\n  public onCameraChanged(callback: (viewport: IViewport) => void): void {\n    this.cameraChangedCallback = callback;\n  }\n\n  private handleCameraChanged = () => {\n    // @see https://github.com/mapbox/mapbox-gl-js/issues/2572\n    const { lat, lng } = this.map.getCenter().wrap();\n    // Tip: 统一触发地图变化事件\n    this.emit('mapchange');\n    // resync\n    this.viewport.syncWithMapCamera({\n      bearing: this.map.getBearing(),\n      center: [lng, lat],\n      viewportHeight: this.map.transform.height,\n      pitch: this.map.getPitch(),\n      viewportWidth: this.map.transform.width,\n      zoom: this.map.getZoom(),\n      // mapbox 中固定相机高度为 viewport 高度的 1.5 倍\n      cameraHeight: 0,\n    });\n\n    const { offsetZoom = LNGLAT_OFFSET_ZOOM_THRESHOLD } = this.config;\n\n    // set coordinate system\n    if (this.viewport.getZoom() > offsetZoom) {\n      this.coordinateSystemService.setCoordinateSystem(\n        CoordinateSystem.LNGLAT_OFFSET,\n      );\n    } else {\n      this.coordinateSystemService.setCoordinateSystem(CoordinateSystem.LNGLAT);\n    }\n\n    this.cameraChangedCallback(this.viewport);\n  };\n\n  // private creatAmapContainer(id: string | HTMLDivElement) {\n  //   let $wrapper = id as HTMLDivElement;\n  //   if (typeof id === 'string') {\n  //     $wrapper = document.getElementById(id) as HTMLDivElement;\n  //   }\n  //   return $wrapper;\n  // }\n  private creatAmapContainer(id: string | HTMLDivElement) {\n    let $wrapper = id as HTMLDivElement;\n    if (typeof id === 'string') {\n      $wrapper = document.getElementById(id) as HTMLDivElement;\n    }\n    const $amapdiv = document.createElement('div');\n    $amapdiv.style.cssText += `\n      position: absolute;\n      top: 0;\n      height: 100%;\n      width: 100%;\n    `;\n    $amapdiv.id = 'l7_mapbox_div' + mapdivCount++;\n    $wrapper.appendChild($amapdiv);\n    return $amapdiv;\n  }\n  private getMapStyle(name: MapStyle) {\n    if (typeof name !== 'string') {\n      return name;\n    }\n    return MapTheme[name] ? MapTheme[name] : name;\n  }\n}\n"],"file":"map.js"}